[![DAML logo](daml-logo.png)](https://www.daml.com)

Copyright 2020 Digital Asset (Switzerland) GmbH and/or its affiliates. All Rights Reserved.
SPDX-License-Identifier: Apache-2.0

# Support and tooling for creating manual code coverage reports

Motivation for creating such reports is to measure code coverage of integration tests like `//ledger/ledger-on-memory:conformance-test`.
This approach is using [Jacoco](https://www.jacoco.org/), a well-known code coverage solution for JVM languages.

## Content

`lib/`  - Jacoco library binaries (Java-agent to generate coverage data and a cli binary to generate report)

`sh/` - helper script to generate coverage report (this can be used after the raw coverage data was generated)

`src/` - source code for collectsrc tool, which collects all Java/Scala sources in a specified directory in the same directory structure which is conforming to the package of the source file  

## Working directory

`report` - is the root of the working directory - in the root of the project. If not present it will be generated automatically.

`report/jacoco.exec` - the raw coverage data generated by the Jacoco java-agent.

`report/class` - the full classpath of the testee process. Needed by Jacoco report generation.

`report/src` - all relevant source files in a directory structure conforming to the package structure. Needed by Jacoco report generation.

`report/html` - this is the root of the generated HTML report. This is the output of the procedure.

## Steps to generate the code coverage report

### 1. Generate raw Jacoco code coverage runtime data

The conformance test consists of a server process and a client process what is executing a series of tests against the server. We need to measure the coverage data of the server process so as first step we need to start the server process with the jacoco java-agent attached:

```
bazel run \
   //ledger/ledger-on-memory:app \
   -- \
   --jvm_flag="-javaagent:$(pwd)/bazel_tools/coverage_reporting/lib/jacocoagent.jar=destfile=$(pwd)/report/jacoco.exec" \
   --contract-id-seeding=testing-weak \
   --participant participant-id=example,port=6865 \
   --batching enable=true,max-batch-size-bytes=262144
```
This and all following commands need to be executed from the daml root directory. 
The `--jvm_flag` param need to come first after the `--`. 
`destfile=$(pwd)/report/jacoco.exec` specifies the raw Jacoco coverage data target. This will be generated with 0 size as the JVM starts, and will be filled with the raw data upon graceful JVM termination.

Next we need to execute the tests agains the running ledger instance:

`bazel run //ledger/ledger-api-test-tool -- --verbose localhost:6865`

After this is finished we need to gracefully stop the server process (Crtl-C in terminal of the running process suffice)

At this point the jacoco.exec file should be filled with all the content.

### Using the `generate-coverage-report.sh` script

Please note that the following steps are captured by this script for convenience:

`./bazel_tools/coverage_reporting/sh/generate-coverage-report.sh`

### 2. Collect relevant binaries

First we can create a singlejar, containing the full needed classpath for the server process with this command:

`bazel build //ledger/ledger-on-memory:app_deploy.jar`

Next we need to extract from this jar archive all the relevant classes which we target for code coverage:

`unzip bazel-bin/ledger/ledger-on-memory/app_deploy.jar com/daml/* -d report/class`

### 3. Collect relevant sources

Now we can run the `collectsrcs` tool to populate all the sources in the right directory structure. 
This simple app is using a crude "good enough" heuristic to capture the package information from the Scala and Java source files, and then copying the source file in a directory which is conforming to the package structure.

`bazel run //bazel_tools/coverage_reporting:run_collectsrc -- $(pwd) $(pwd)/report/src`

### 4. Generate the HTML report

From all the prepared input created above we can now generate the HTML report itself by using the Jacoco CLI:

```
java -jar $(pwd)/bazel_tools/coverage_reporting/lib/jacococli.jar \
      report \
      report/jacoco.exec \
      --classfiles report/class \
      --html report/html \
      --sourcefiles report/src
```
